/**
-----BEGIN PGP PUBLIC KEY BLOCK-----

mQINBFNVyeABEADEDoO4rX8v+uA0tdr6GKAQITGGaaxNKy8teKSNHLaU+a3WG0ZW
ue9l125dG3NESYTl43Nx+/9BhDCZUYB6VgQ2dKNTYhuxY+BGbXCL/LDXX0555kV7
jRkItz1dow+IFKoT2lIKmq6OhEg3+EUoS2cABBl7HHgs2XMvYbfdiGQza8lv6v9p
KameL1N5P/O/ETAM1RbCYkuIpYSGxOYpVufnIpBXrIRc/TGTteyKz9YraqpfUVvT
zgVF2v6JKne2DtZO7mXh3iV63jf58cO6ydgwbI1ciZz554bfbCgFq5cfS1CMPEBi
rb7nrR3a/EYXemSg1yzck2pUznvIlWsHsmsZvRjyqmFWZpv5xACBwbwtEA3afFfU
4mxhEUEYN+viaC5uz/zHii7sOqNRb47s185qcp+1SfU/EwC63XvMQ5yf1sAmcd1p
1u8AEmo8OtEuWJbi5TJJ7siMr0Tc1Kk2H4kgTP69CiauFx0ZliHiF+/A7eLoM7Du
fNeBowr5yyc+ojoURUq64Ls0ahE5FmLH0O0a56jDoxTzQ/ABULgLFpZLutcVQ0X9
fmiyV6M109MbneHKIX9l+9xCyTWxzLQ1yGAREOTUvtEKq+RIop8QpR5Rt+bogYfH
Cw99ICZzMgX6ep16YYry+CWELyrVzACu91oR55o7HVEids7hbXl9gt/soQARAQAB
tBZBZHVkYWxlc2RpIEdhbmlsYWRpc2RpiQI3BBMBCgAhBQJTVcngAhsDBQsJCAcD
BRUKCQgLBRYCAwEAAh4BAheAAAoJEH9Qoanmww09UpAP/2O7sLdOG4/87i2n3i3a
FjWXH6xEuFQrj1OtCm1zT4mKZSiZSD0ZBTuG4YJ3CdDtJfbZO6yD7akEH7xbvzRi
lFnjjYJKpGYLBe+9dJuCKxAD3RAWkJVQRq/L8jH4xol+Fa8gho5gA4aWOyI/7bZA
FEVN1FYM4X+7/Y4CldBgViPp2MKpltSfkvQb9VdbJxFI6IuSgK+4yuz3i2I0Xk9A
b7ZUbNHPxLJwjR1QOzPj+bHoCjgr5PTT6gRgMCCe6RaXvma7ea2wWSbpNU/rus2d
Jf60dXA6R78tr8J2Rm1UjXBDbZRXCQcB0kyWOrXcrtbQARuEgcnkmjPeZc5vs8Yd
jv46Tm5g1BOGkHMHPr0ZkP269NfoLNQPwWabT1ZrSX9HkGBeEB5KphETxz186nWU
zGr7XqlITrmi3dKsIHup0ghecNBwb6uT36hK5Ny8C9U2EVDo3gAkotcTd4vBqN4+
fXB8FLM2W1iK89rgtKEkGEB+oBpNdMpVvGRhL6UVKQPI4StQfMu9JQrxwtZZvJ/J
39aJ8TrRp81WQbRyKQh+I6xVmssVA+J2CINUSMKAgJkX3Chzq/zipArlQ4n+33ru
OBSLoRwPoPM1ATkVuOO6o0h+s4MRRvRTfRYm91UD4wn4IwXpQZrW0cjst7YT5pGV
XZIci3gibvGDs2R742Q6jrlmuQINBFNVyeABEADHe49H+TQJxswV8XZBD01+1ARI
sjRvvFckDD6myr8wo7FFjyj0DMiKbqbylYVnc+uVpE6xZ5LKkfSRfIhRpHtkaBS2
xYoiJ+aFuh3IW3wNvA8E1g6olID5N/RIMmZNmCyAnnQt0CSOw+WP+dAqnH5K7G1b
r7lORvEudltL8idl/cofBISYwO8Dcq7a9SQfNrrpaHKfl48aAS4TqHETYTVIx5Yl
bD/6YF9GgkzzbscOs1eDAf5wnTXhbI9ktvv9DFvuZPXSO+T2Z3sQJoQZbOJudYRp
biaYw3kNwQzAMTBS8re6Q+w7utYj6T4qJndAUGWhmuW+SiP6pQmFntOQMTbN5Nsp
I/aB/OlfGexluRKwu3LCIXu8EKCyrOCHNZul8Tx+te23K5yW8rh9QIbbhP/JrJ1/
jS0s7F4bt3d67F2oPfjzaC3KTq5gbZBWMZ7j+vzeJNHUmQLShKycD5krRpsQRCaV
JY4yygjIZvraklt93JxUaHR6WhW8XVliVxQC7YLWhoekbwA4+KY/DSYHKfMCa5TS
dEg9g+CDLhPCMyEue7u+RCBHCaKPaOwIk/bUBFr0ybMVxkX6NgPtunpqIHm1PDNV
Fe52vgacZWXJjyZYM38I+Zm3FKL0yqKi6QlUq9uY5H69IrahEABsDOoi4XCWtadJ
BOzLfqBR+PISs8wPTwARAQABiQIfBBgBCgAJBQJTVcngAhsMAAoJEH9Qoanmww09
EN4P/1BuM6lYUoIskbQuYG4yZH5oHwvJ6z9uhPHrjV9XIg8XGK7eWYQzIBH+UrZL
8fuseBnpyLY+vC0jPA1LWtXHtFyMcK/b1jUd/i+tLE5qyt+mG70E3DrgwuQR6pei
Yt6R8XANPMrC4MJznNXoLGdo6IEjF8va040gdCGsskKlUHaOFPhHvNT1UGUHTtss
/270PMxJ0jgv5DSjVAujbp7RMViyIHESCSiHwMTdMFCjv+M5smMpnRb2I3feXXZ2
raHGUHh6NL0NdtfWmNS3hyYcSsOpTb3dJoXEzA2J9WwsTBkU+lrpT76t0t2qiRfL
T/UU6ZHg0OIU5HqtjTMEZdBmZQsZrJ7V0L2+x2u262ppu6y1FscaYQOfxApLPRkQ
F7yF/xABzGpsEgbMKUJo4mjBxIYCRwAuPUh8NYpQ9YoPXu5M8Zoj+SM+PDvzo5Ei
pHWtMRf4r28/4+PsjO0ZINzGIz3Vnqfnyi7i0d3FkeD3ziO8KPy/S8JDCD/SlY8f
MVjKZ1IqhjVJJeFCgQIGYE3F0pVwUrhJWHW1zC/e3/9C3Nu/wZU+DBLHNnqNezpZ
JViiXT4V/7ro2RhGGFRLIf7hHtNzDBVmbHF5Z/pjaMfVFtcpT08KBgs/84WXnPIJ
JIczNgEcuJY7GHQ+gw5VIFhhYJAay1QjVvneTtOKKTcPHoLm
=xxdb
-----END PGP PUBLIC KEY BLOCK-----
 */

#import <objc/objc-runtime.h>

#import "COMainWindowController.h"
#import "COMarketViewController.h"
#import "COMessageWindowController.h"
#import "COTradesTableView.h"

@interface COMainWindowController ()
@property (assign) IBOutlet NSWindow * windowMarketAdd;
@property (assign) IBOutlet NSTextField * textFieldMarketAddLeftSymbol;
@property (assign) IBOutlet NSTextField * textFieldMarketAddRightSymbol;
@property (assign) IBOutlet NSTableView * tableViewMarkets;
@property (assign) IBOutlet COTradesTableView * tableViewTrades;
@property (assign) IBOutlet NSView * viewMarket;
@property (assign) IBOutlet NSWindow * windowTrade;
@property (assign) IBOutlet NSPopover * popoverTrade;
@property (assign) IBOutlet NSTextField * textFieldTrade0;
@property (assign) IBOutlet NSTextField * textFieldTrade1;
@property (assign) IBOutlet NSTextField * textFieldTrade2;
@property (assign) IBOutlet NSTextField * textFieldTrade3;
@property (assign) IBOutlet NSTextField * textFieldTrade4;
@property (assign) IBOutlet NSTextField * textFieldTrade5;
@property (strong) NSMutableArray * markets;
@property (strong) NSMutableArray * trades;
@end

/**
 * This needs to be a class but I am under extreme pressure that is out of
 * my control.
 */
static NSMutableDictionary * gMessageWindowControllers = nil;

@implementation COMainWindowController

- (id)init
{
    self = [super initWithWindowNibName:@"MainWindow" owner:self];
    
    if (self)
    {
        self.markets = [NSMutableArray new];
        self.trades = [NSMutableArray new];
        
        [[NSNotificationCenter defaultCenter] addObserver:self
            selector:@selector(tradeDidUpdateNotification:)
            name:kCOTradeDidUpdateNotification object:nil
        ];
        
        [[NSNotificationCenter defaultCenter] addObserver:self
            selector:@selector(didReceiveChatMessageNotification:)
            name:kCODidReceiveChatMessageNotification object:nil
        ];
    }
    return self;
}

- (void)windowDidLoad
{
    [super windowDidLoad];
    
    self.tableViewTrades.delegateTrades = self;
    
    // Implement this method to handle any initialization after your window controller's window has been loaded from its nib file.
}

#pragma mark -

- (IBAction)actionShowMarketAdd:(id)sender
{
    [self.window beginSheet:self.windowMarketAdd completionHandler:nil];
}

- (IBAction)actionMarketAdd:(id)sender
{
    NSString * leftSymbol = self.textFieldMarketAddLeftSymbol.stringValue;
    NSString * rightSymbol = self.textFieldMarketAddRightSymbol.stringValue;
    
    if (leftSymbol.length > 0 && leftSymbol.length > 0)
    {
        NSString * market = [NSString stringWithFormat:
            @"%@/%@", leftSymbol.uppercaseString, rightSymbol.uppercaseString
        ];
        
        if ([[COStack sharedInstance] marketAdd:market])
        {
            COMarketViewController * marketViewController = [
                [COMarketViewController alloc] initWithMarket:market
            ];
        
            if (self.viewMarket.subviews.count > 0)
            {
                [self.viewMarket.subviews[0] removeFromSuperview];
            }
            
            [self.viewMarket addSubview:marketViewController.view];
            
            marketViewController.view.frame = self.viewMarket.bounds;
            
            [self.markets addObject:marketViewController];
            
            [self.tableViewMarkets reloadData];
            
            [self.tableViewMarkets selectRowIndexes:
                [NSIndexSet indexSetWithIndex:self.markets.count - 1]
                byExtendingSelection:NO
            ];
        }
        
        [self.window endSheet:self.windowMarketAdd];
    }
    else
    {
        NSBeep();
    }
}

- (IBAction)actionMarketCancel:(id)sender
{
    [self.window endSheet:self.windowMarketAdd];
}

- (IBAction)actionSendMessage:(id)sender
{
    NSDictionary * info = objc_getAssociatedObject(
        self.popoverTrade, "info"
    );
    
    NSString * username =
        [info objectForKey:@"seller"] ? [info objectForKey:@"seller"] :
        [info objectForKey:@"buyer"]
    ;
    
    NSLog(@"username = %@", username);
    
    if (gMessageWindowControllers == nil)
    {
        gMessageWindowControllers = [NSMutableDictionary new];
    }
    
    COMessageWindowController * messageWindowController = [
        gMessageWindowControllers objectForKey:username
    ];
    
    if (messageWindowController == nil)
    {
        messageWindowController = [[
            COMessageWindowController alloc] initWithUsername:username
        ];
        
        [gMessageWindowControllers setObject:messageWindowController
            forKey:username
        ];
    }
    
    [messageWindowController.window makeKeyAndOrderFront:nil];
}

#pragma mark -

- (NSInteger)numberOfRowsInTableView:(NSTableView *)tableView
{
    if (self.tableViewMarkets == tableView)
    {
        return self.markets.count;
    }
    else if (self.tableViewTrades == tableView)
    {
        return self.trades.count;
    }
    
    return 0;
}

- (id)tableView:(NSTableView *)tableView
    objectValueForTableColumn:(NSTableColumn *)tableColumn row:(NSInteger)row
{
    if (self.tableViewMarkets == tableView)
    {
        COMarketViewController * marketViewController =
            [self.markets objectAtIndex:row]
        ;

        return marketViewController.market;
    }
    else if (self.tableViewTrades == tableView)
    {
        NSDictionary * trade = [self.trades objectAtIndex:row];
        
        NSDictionary * info = [trade objectForKey:@"info"];
        
        NSString * timestamp = [info objectForKey:@"timestamp"];
        
        NSDate * epoch = [[NSDate alloc]
            initWithTimeIntervalSince1970:timestamp.doubleValue
        ];
        
        NSDateFormatter * dateFormatter = [[NSDateFormatter alloc] init];
        [dateFormatter setDateStyle:NSDateFormatterMediumStyle];
        [dateFormatter setTimeStyle:NSDateFormatterMediumStyle];
        
        return [dateFormatter stringFromDate:epoch];

    }

    return nil;
}

- (CGFloat)tableView:(NSTableView *)tableView heightOfRow:(NSInteger)row
{
    return 22.0f;
}

- (void)tableViewSelectionDidChange:(NSNotification *)aNotification
{
    NSInteger rowIndex = -1;
    
    if (self.tableViewMarkets == aNotification.object)
    {
        rowIndex = [self.tableViewMarkets selectedRow];
        
        COMarketViewController * marketViewController = [self.markets
            objectAtIndex:rowIndex
        ];
        
        [self.viewMarket.subviews[0] removeFromSuperview];
        
        marketViewController.view.frame = self.viewMarket.bounds;
        
        [self.viewMarket addSubview:marketViewController.view];
    }
    else if (self.tableViewTrades == aNotification.object)
    {
        rowIndex = [self.tableViewTrades selectedRow];
    }
}

#pragma mark -

- (void)tableView:(COTradesTableView *)tableView didClickedRow:(NSInteger)row
{
    [self.popoverTrade close];

    CGRect rect = [tableView rectOfRow:row];
    
    NSDictionary * trade = [self.trades objectAtIndex:row];
    
    NSDictionary * info = [trade objectForKey:@"info"];

    NSArray * marketSymbols = [[info objectForKey:@"market"]
        componentsSeparatedByString:@"/"
    ];
    
    NSParameterAssert(marketSymbols.count == 2);
    
    self.textFieldTrade0.stringValue = [NSString
        stringWithFormat:NSLocalizedString(@"Market: %@", nil),
        [info objectForKey:@"market"]
    ];
    
    if ([info objectForKey:@"buyer"])
    {
        self.textFieldTrade1.stringValue = [NSString
            stringWithFormat:NSLocalizedString(@"Buyer: %@", nil),
            [info objectForKey:@"buyer"]
        ];
        
        NSNumber * total = [NSNumber numberWithFloat:
            [[info objectForKey:@"price"] floatValue] *
            [[info objectForKey:@"quantity"] floatValue]
        ];
        
        self.textFieldTrade5.stringValue = [NSString
            stringWithFormat:NSLocalizedString(
            @"Notes: You owe %@ %@ %@. %@ owes you %@ %@.", nil),
            [info objectForKey:@"buyer"], [info objectForKey:@"quantity"],
            marketSymbols[0], [info objectForKey:@"buyer"],
            total, marketSymbols[1]
        ];
    }
    else if ([info objectForKey:@"seller"])
    {
        self.textFieldTrade1.stringValue = [NSString
            stringWithFormat:NSLocalizedString(@"Seller: %@", nil),
            [info objectForKey:@"seller"]
        ];
        
        NSNumber * total = [NSNumber numberWithFloat:
            [[info objectForKey:@"price"] floatValue] *
            [[info objectForKey:@"quantity"] floatValue]
        ];
        
        self.textFieldTrade5.stringValue = [NSString
            stringWithFormat:NSLocalizedString(
            @"Notes: You owe %@ %@ %@. %@ owes you %@ %@.", nil),
            [info objectForKey:@"seller"], total,
            marketSymbols[1], [info objectForKey:@"seller"],
            [info objectForKey:@"quantity"], marketSymbols[0]
        ];
    }
    else
    {
        assert(0);
    }
    
    self.textFieldTrade2.stringValue = [NSString
        stringWithFormat:NSLocalizedString(@"Price: %@", nil),
        [info objectForKey:@"price"]
    ];
    self.textFieldTrade3.stringValue = [NSString
        stringWithFormat:NSLocalizedString(@"Quantity: %@", nil),
        [info objectForKey:@"quantity"]
    ];
    
    self.textFieldTrade4.stringValue = [NSString
        stringWithFormat:NSLocalizedString(@"State: %@", nil),
        [[info objectForKey:@"state"] capitalizedString]
    ];
    
    objc_setAssociatedObject(
        self.popoverTrade, "info", info, OBJC_ASSOCIATION_RETAIN
    );
    
    [self.popoverTrade showRelativeToRect:rect
        ofView:tableView preferredEdge:NSMaxXEdge
    ];
}

#pragma mark - NSPopoverDelegate

- (NSWindow *)detachableWindowForPopover:(NSPopover *)popover
{
    #warning :FIXME
    return self.windowTrade;
}

#pragma mark - NSSplitView Delegate

- (CGFloat)splitView:(NSSplitView *)splitView
    constrainMinCoordinate:(CGFloat)proposedMinimumPosition
    ofSubviewAt:(NSInteger)dividerIndex
{
    return 120;
}

- (CGFloat)splitView:(NSSplitView *)splitView
    constrainMaxCoordinate:(CGFloat)proposedMaximumPosition
    ofSubviewAt:(NSInteger)dividerIndex
{
    return 180;
}

- (void)splitView:(NSSplitView *)sender
    resizeSubviewsWithOldSize:(NSSize)oldSize
{
    CGFloat dividerThickness = sender.dividerThickness;
    NSRect leftRect  = [[sender.subviews objectAtIndex:0] frame];
    NSRect rightRect = [[sender.subviews objectAtIndex:1] frame];
    NSRect newFrame  = sender.frame;

    leftRect.size.height = newFrame.size.height;
    leftRect.origin = NSMakePoint(0, 0);
    
    rightRect.size.width =
        newFrame.size.width - leftRect.size.width - dividerThickness
    ;
    rightRect.size.height = newFrame.size.height;
    rightRect.origin.x = leftRect.size.width + dividerThickness;

    [[[sender subviews] objectAtIndex:0] setFrame:leftRect];
    [[[sender subviews] objectAtIndex:1] setFrame:rightRect];
}

#pragma mark -

- (void)tradeDidUpdateNotification:(NSNotification *)aNotification
{
    NSDictionary * dict = aNotification.object;
    
    NSNumber * tid = [dict objectForKey:@"tid"];
    
    NSDictionary * trade = dict.copy;
    
    BOOL found = NO;
    
    NSDictionary * trade2 = nil;
    
    for (trade2 in self.trades)
    {
        NSString * buyer = [[trade objectForKey:@"info"] objectForKey:@"buyer"];
        NSString * seller = [[trade objectForKey:@"info"] objectForKey:@"seller"];
        
        if ([tid isEqualToNumber:[trade2 objectForKey:@"tid"]])
        {
            if (
                buyer && [buyer isEqualToString:
                [[trade2 objectForKey:@"info"] objectForKey:@"buyer"]]
                )
            {
                found = YES;
                
                break;
            }
            else if (
                seller && [seller isEqualToString:
                [[trade2 objectForKey:@"info"] objectForKey:@"seller"]]
                )
            {
            
                found = YES;
                
                break;
            }
        }
    }
    
    if  (found == NO)
    {
        [self.trades addObject:trade];
    }
    else
    {
        [self.trades replaceObjectAtIndex:
            [self.trades indexOfObject:trade2] withObject:trade
        ];
    }
    
    [self.tableViewTrades reloadData];
}

#pragma mark -

- (void)didReceiveChatMessageNotification:(NSNotification *)aNotification
{
    NSDictionary * message = aNotification.object;
    
    NSString * to = [message objectForKey:@"to"];
    
    if (
        [to isEqualToString:[[NSUserDefaults standardUserDefaults]
        objectForKey:@"username"]]
    )
    {
        NSString * from = [message objectForKey:@"from"];
        
        NSLog(@"from = %@", from);
        
        COMessageWindowController * messageWindowController = [
            gMessageWindowControllers objectForKey:from
        ];
        
        if (messageWindowController == nil)
        {
            messageWindowController = [[
                COMessageWindowController alloc] initWithUsername:from
            ];
            
            [gMessageWindowControllers setObject:messageWindowController
                forKey:from
            ];
        }
        
        [messageWindowController.window makeKeyAndOrderFront:nil];
    }
}

#pragma mark -

- (void)dealloc
{
    [[NSNotificationCenter defaultCenter] removeObserver:self];
}

@end
