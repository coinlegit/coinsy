/**
-----BEGIN PGP PUBLIC KEY BLOCK-----

mQINBFNVyeABEADEDoO4rX8v+uA0tdr6GKAQITGGaaxNKy8teKSNHLaU+a3WG0ZW
ue9l125dG3NESYTl43Nx+/9BhDCZUYB6VgQ2dKNTYhuxY+BGbXCL/LDXX0555kV7
jRkItz1dow+IFKoT2lIKmq6OhEg3+EUoS2cABBl7HHgs2XMvYbfdiGQza8lv6v9p
KameL1N5P/O/ETAM1RbCYkuIpYSGxOYpVufnIpBXrIRc/TGTteyKz9YraqpfUVvT
zgVF2v6JKne2DtZO7mXh3iV63jf58cO6ydgwbI1ciZz554bfbCgFq5cfS1CMPEBi
rb7nrR3a/EYXemSg1yzck2pUznvIlWsHsmsZvRjyqmFWZpv5xACBwbwtEA3afFfU
4mxhEUEYN+viaC5uz/zHii7sOqNRb47s185qcp+1SfU/EwC63XvMQ5yf1sAmcd1p
1u8AEmo8OtEuWJbi5TJJ7siMr0Tc1Kk2H4kgTP69CiauFx0ZliHiF+/A7eLoM7Du
fNeBowr5yyc+ojoURUq64Ls0ahE5FmLH0O0a56jDoxTzQ/ABULgLFpZLutcVQ0X9
fmiyV6M109MbneHKIX9l+9xCyTWxzLQ1yGAREOTUvtEKq+RIop8QpR5Rt+bogYfH
Cw99ICZzMgX6ep16YYry+CWELyrVzACu91oR55o7HVEids7hbXl9gt/soQARAQAB
tBZBZHVkYWxlc2RpIEdhbmlsYWRpc2RpiQI3BBMBCgAhBQJTVcngAhsDBQsJCAcD
BRUKCQgLBRYCAwEAAh4BAheAAAoJEH9Qoanmww09UpAP/2O7sLdOG4/87i2n3i3a
FjWXH6xEuFQrj1OtCm1zT4mKZSiZSD0ZBTuG4YJ3CdDtJfbZO6yD7akEH7xbvzRi
lFnjjYJKpGYLBe+9dJuCKxAD3RAWkJVQRq/L8jH4xol+Fa8gho5gA4aWOyI/7bZA
FEVN1FYM4X+7/Y4CldBgViPp2MKpltSfkvQb9VdbJxFI6IuSgK+4yuz3i2I0Xk9A
b7ZUbNHPxLJwjR1QOzPj+bHoCjgr5PTT6gRgMCCe6RaXvma7ea2wWSbpNU/rus2d
Jf60dXA6R78tr8J2Rm1UjXBDbZRXCQcB0kyWOrXcrtbQARuEgcnkmjPeZc5vs8Yd
jv46Tm5g1BOGkHMHPr0ZkP269NfoLNQPwWabT1ZrSX9HkGBeEB5KphETxz186nWU
zGr7XqlITrmi3dKsIHup0ghecNBwb6uT36hK5Ny8C9U2EVDo3gAkotcTd4vBqN4+
fXB8FLM2W1iK89rgtKEkGEB+oBpNdMpVvGRhL6UVKQPI4StQfMu9JQrxwtZZvJ/J
39aJ8TrRp81WQbRyKQh+I6xVmssVA+J2CINUSMKAgJkX3Chzq/zipArlQ4n+33ru
OBSLoRwPoPM1ATkVuOO6o0h+s4MRRvRTfRYm91UD4wn4IwXpQZrW0cjst7YT5pGV
XZIci3gibvGDs2R742Q6jrlmuQINBFNVyeABEADHe49H+TQJxswV8XZBD01+1ARI
sjRvvFckDD6myr8wo7FFjyj0DMiKbqbylYVnc+uVpE6xZ5LKkfSRfIhRpHtkaBS2
xYoiJ+aFuh3IW3wNvA8E1g6olID5N/RIMmZNmCyAnnQt0CSOw+WP+dAqnH5K7G1b
r7lORvEudltL8idl/cofBISYwO8Dcq7a9SQfNrrpaHKfl48aAS4TqHETYTVIx5Yl
bD/6YF9GgkzzbscOs1eDAf5wnTXhbI9ktvv9DFvuZPXSO+T2Z3sQJoQZbOJudYRp
biaYw3kNwQzAMTBS8re6Q+w7utYj6T4qJndAUGWhmuW+SiP6pQmFntOQMTbN5Nsp
I/aB/OlfGexluRKwu3LCIXu8EKCyrOCHNZul8Tx+te23K5yW8rh9QIbbhP/JrJ1/
jS0s7F4bt3d67F2oPfjzaC3KTq5gbZBWMZ7j+vzeJNHUmQLShKycD5krRpsQRCaV
JY4yygjIZvraklt93JxUaHR6WhW8XVliVxQC7YLWhoekbwA4+KY/DSYHKfMCa5TS
dEg9g+CDLhPCMyEue7u+RCBHCaKPaOwIk/bUBFr0ybMVxkX6NgPtunpqIHm1PDNV
Fe52vgacZWXJjyZYM38I+Zm3FKL0yqKi6QlUq9uY5H69IrahEABsDOoi4XCWtadJ
BOzLfqBR+PISs8wPTwARAQABiQIfBBgBCgAJBQJTVcngAhsMAAoJEH9Qoanmww09
EN4P/1BuM6lYUoIskbQuYG4yZH5oHwvJ6z9uhPHrjV9XIg8XGK7eWYQzIBH+UrZL
8fuseBnpyLY+vC0jPA1LWtXHtFyMcK/b1jUd/i+tLE5qyt+mG70E3DrgwuQR6pei
Yt6R8XANPMrC4MJznNXoLGdo6IEjF8va040gdCGsskKlUHaOFPhHvNT1UGUHTtss
/270PMxJ0jgv5DSjVAujbp7RMViyIHESCSiHwMTdMFCjv+M5smMpnRb2I3feXXZ2
raHGUHh6NL0NdtfWmNS3hyYcSsOpTb3dJoXEzA2J9WwsTBkU+lrpT76t0t2qiRfL
T/UU6ZHg0OIU5HqtjTMEZdBmZQsZrJ7V0L2+x2u262ppu6y1FscaYQOfxApLPRkQ
F7yF/xABzGpsEgbMKUJo4mjBxIYCRwAuPUh8NYpQ9YoPXu5M8Zoj+SM+PDvzo5Ei
pHWtMRf4r28/4+PsjO0ZINzGIz3Vnqfnyi7i0d3FkeD3ziO8KPy/S8JDCD/SlY8f
MVjKZ1IqhjVJJeFCgQIGYE3F0pVwUrhJWHW1zC/e3/9C3Nu/wZU+DBLHNnqNezpZ
JViiXT4V/7ro2RhGGFRLIf7hHtNzDBVmbHF5Z/pjaMfVFtcpT08KBgs/84WXnPIJ
JIczNgEcuJY7GHQ+gw5VIFhhYJAay1QjVvneTtOKKTcPHoLm
=xxdb
-----END PGP PUBLIC KEY BLOCK-----
 */

#ifndef COINSY_MARKET_HPP
#define COINSY_MARKET_HPP

#include <cstdint>
#include <memory>
#include <mutex>
#include <string>
#include <vector>

#include <boost/asio.hpp>

#include <database/query.hpp>

namespace coinsy {

    class ask;
    class bid;
    class stack_impl;
    
    /**
     * Implements a market.
     */
    class market : public std::enable_shared_from_this<market>
    {
        public:
        
            /**
             * Constructor
             * @param ios The boost::asio::io_service.
             * @param owner The stack_impl.
             * @param symbols The symbols.
             */
            market(boost::asio::io_service &, stack_impl &, const std::string &);
        
            /**
             * Starts
             */
            void start();
        
            /**
             * Stops
             */
            void stop();
        
            /**
             * Places an ask order in the market.
             * @param price The price.
             * @param quantity The quantity.
             */
            std::uint32_t place_ask(const float & price, const float & quantity);
        
            /**
             * Places a bid order in the market.
             * @param price The price.
             * @param quantity The quantity.
             */
            std::uint32_t place_bid(const float & price, const float & quantity);
        
            /**
             * Cancels an order.
             * @param id The id.
             */
            bool cancel_order(const std::uint32_t & id);
        
            /**
             * Caled when an ask is found.
             * @param q The query.
             */
            void on_find_ask(database::query & q);
        
            /**
             * Caled when an bid is found.
             * @param q The query.
             */
            void on_find_bid(database::query & q);

            /**
             * Caled when a buy is received.
             * @param q The query.
             */
            void on_route_buy(database::query & q);
        
            /**
             * Caled when a sell is received.
             * @param q The query.
             */
            void on_route_sell(database::query & q);
        
            /**
             * Caled when a trade is found.
             * @param q The query.
             */
            void on_find_trade(database::query & q);
        
            /**
             * The name.
             */
            const std::string name() const;
        
            /**
             * The left symbol.
             */
            const std::string & left_symbol() const;
        
            /**
             * The right symbol.
             */
            const std::string & right_symbol() const;

            /**
             * operator==
             */
            bool operator==(const market &) const;
  
        private:
        
            /**
             * The left symbol.
             */
            std::string m_left_symbol;
        
            /**
             * The right symbol.
             */
            std::string m_right_symbol;
        
            /**
             * The lowest ask.
             */
            float m_lowest_ask;
        
            /**
             * The highest bid.
             */
            float m_highest_bid;

            /**
             * The open asks.
             */
            std::vector< std::shared_ptr<ask> > m_open_asks;
        
            /**
             * The open bids.
             */
            std::vector< std::shared_ptr<bid> > m_open_bids;

            /**
             * The pending asks.
             */
            std::vector< std::shared_ptr<ask> > m_pending_asks;
        
            /**
             * The pending bids.
             */
            std::vector< std::shared_ptr<bid> > m_pending_bids;
        
            /**
             * The public asks.
             */
            std::vector< std::shared_ptr<ask> > m_public_asks;
        
            /**
             * The public bids.
             */
            std::vector< std::shared_ptr<bid> > m_public_bids;
        
        protected:
        
            /**
             * Performs a ask lookup on the symbol pair.
             */
            void lookup_ask();
        
            /**
             * Performs a bid lookup on the symbol pair.
             */
            void lookup_bid();
        
            /**
             * Performs a public asks maintenance operation.
             */
            void maintain_public_asks();
        
            /**
             * Performs a public bids maintenance operation.
             */
            void maintain_public_bids();
        
            /**
             * The lookup interval in seconds.
             */
            enum { interval_lookup = 4 };
        
            /**
             * The maximum number of lookup results.
             * @note The database supports a maximum of 200 results.
             */
            enum { max_lookup_results = 200 };
        
            /**
             * The maintanance interval in seconds.
             */
            enum { interval_maintanance = 4 };
        
            /**
             * The boost::asio::io_service.
             */
            boost::asio::io_service & io_service_;
        
            /**
             * The boost::asio::strand.
             */
            boost::asio::strand strand_;
        
            /**
             * The stack_impl.
             */
            stack_impl & stack_impl_;
        
            /**
             * The open asks mutex.
             */
            std::mutex mutex_open_asks_;
        
            /**
             * The open bids mutex.
             */
            std::mutex mutex_open_bids_;
        
            /**
             * The pending asks mutex.
             */
            std::mutex mutex_pending_asks_;
        
            /**
             * The pending bids mutex.
             */
            std::mutex mutex_pending_bids_;
        
            /**
             * The public asks mutex.
             */
            std::mutex mutex_public_asks_;
        
            /**
             * The public bids mutex.
             */
            std::mutex mutex_public_bids_;
        
            /**
             * The ask lookup timer.
             */
            boost::asio::basic_waitable_timer<
                std::chrono::steady_clock
            > timer_ask_lookup_;
        
            /**
             * The bid lookup timer.
             */
            boost::asio::basic_waitable_timer<
                std::chrono::steady_clock
            > timer_bid_lookup_;
        
            /**
             * The public asks timer.
             */
            boost::asio::basic_waitable_timer<
                std::chrono::steady_clock
            > timer_public_asks_;
        
            /**
             * The public bids timer.
             */
            boost::asio::basic_waitable_timer<
                std::chrono::steady_clock
            > timer_public_bids_;
    };

} // namespace coinsy

#endif // COINSY_MARKET_HPP
